---
title:  事务知识点 
date: 2016-10-01 19:20:43
updated: 2016-10-01 20:19:21
categories: 并发控制相关知识点
tags: [事务]
copyright: true
mathjax: true
---

### 事务
&emsp;&emsp;本文主要介绍事务的相关知识点，同时也为后续讲解乐观锁和悲观锁作铺垫，先对以下事务相关的知识点：``ACID``、``事物的常见问题``以及``事务的隔离级别``先做介绍，至于``锁``后续会有专题详细介绍。
事务就是一组原子性的sql，或者一个独立的工作单元，事务可以就Mysql引擎来说的话就是要么全部执行这一组sql语句（CURD组合），要么全部都不执行（比如其中一条语句失败会导致这一组语句全部失败）。 
事务是并发控制的单元，是用户定义的一个操作序列。这些操作要么都做，要么都不做，是一个不可分割的工作单位，说白了就是为了保证系统始终处于一个完整且正确的状态。

<!--more-->

-------

#### 事务特性：ACID  
事务的ACID特性：
##### A：Atomiciy(原子性)：
一个事物必须保证其中的操作要么全部执行，要么全部回滚，不可能存在只执行了一部分这种情况出现。简单说就是事务是一个不可分隔的工作单位，事务中的操作要么都发生，要么都不发生；

事务包含的全部操作是一个不可分割的整体，要么全部执行，要么全部都不执行。
##### C：Consistency(一致性)：
数据必须保证从一种一致性的状态转换为另一种一致性状态。也就是事务开始到结束的时间段内，事务前后数据的完整性必须保证一致；  

例如：事务之前A,B两个账户的总和是10万(A:4W,B:6W),现在A转账B2万(A:2W,B:8W),A,B账户总和依旧应该是10万，如果不是10万的话，则事务前后对于账户总和这种资源是不一致的。
##### I：Isolation(隔离性)：
在一个事物未执行完毕时，通常会保证其他Session无法看到这个事务的执行结果。也就是说多个用户并发访问数据库时，一个用户的事物不能被其他用户的事物所干扰，多个并发事务之间数据要相互隔离。数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的"独立"环境执行；

主要规定了各个事务之间相互影响的程度，主要用于规定多个事务访问同一数据资源，各个事务对该数据资源访问的行为。
##### D：Durability(持久性)：
事务一旦commit，则数据就会保存下来，即使提交完之后系统崩溃，数据也不会丢失。

事务一旦完成，要将数据所做的变更记录下来(冗余存储或多数据网络备份)。

--------------

#### 事务常见问题
##### ``更新丢失(Lost Update)``：
1. 场景：假定两个事物有$A$和$B$，事务$A$和事物$B$同时获得相同的数据，然后在各自的事物中修改数据M，事先$A$先提交事物，数据M假如为$M+$，事务$B$后提交事物，数据$M$变成了$M++$，最终结果变成$M++$，覆盖了事物$A$的更新。  
2. 原因：当多个事务选择同一行操作，并且都是基于最初选定的值，由于每个事务都不知道其他事务的存在，就会发生更新覆盖的问题。类比Github提交冲突。  
3. 例子：   

| 事物$A$ | 事物$B$ |
| --- | --- |
| 读取 $X=100$ | 读取 $X=100$ |
| 写入 $X=X+100$  |   |
| 事物结束 $X = 200$ |  |
|   | 写入 $X =X+100$ |
|   | 事物结束 $X=300$(事物A的数据更新丢失) |
    
    
#####  ``脏读(Dirty Reads)``：
1. 场景：**允许事物B可以读到事物A修改而未提交的数据**，**可能**会造成脏读（脏读本质就是无效数据，只有当事物$A$回滚，那么事物B读到的数据才为无效的，所以这里只是**可能**造成脏读，当事物$A$不回滚的时候，事物$B$读到的数据就不为脏数据，也就是有效的数据，脏数据会导致以后的操作都会发生错误，一定要避免，不能凭借侥幸，事物$A$不能百分之百保证不回滚，所以**这种隔离级别很少用于实际应用**，并且它的性能也不比其他借笔好）。
2. 原因：事物B读取了事物$A$已经修改但尚未提交的数据。若事物$A$回滚数据，事物$A$的数据存在不一致性的问题。
3. 例子：
    
|  事物$A$  | 事物$B$ |
| --- | --- |
| 写入 $X=X+100(x=200)$ |  |
|  | 读取 $X=200$(无效数据，脏读) |
| 事务回滚 $X=100$ |  |
| 事务结束 $X=100$ |  |
|  | 事务结束 |

#####  ``不可重复读(Non-Repeatable Reads)``：
1. 场景：不可重复读是指在一个事务范围中$2$次或者多次查询同一数据$M$返回了不同的数据，例如：事务$B$读取某一数据，事务$A$修改了该数据$M$并且提交，事务$B$又读取该数据$M$(可能是再次校验)，在同一个事务$B$中，读取同一个数据$M$的结果集不同。
2.  原因：事物$B$第一次读取最初数据，第二次读取事物A已经提交的修改或删除数据。导致两次读取数据不一致。不符合事物的隔离性。
3.  例子：
    
| 事物$A$ | 事物$B$ |
| --- | --- |
| 读取 $X=100$ | 读取 $X=100$ |
| 写入 $X=X+100$ | 读取 $X=100$ |
| 事务结束，$X=200$ |  |
|  | 读取 $X=200$(在一个事务B中读X的值发生了变化) |
|  | 事物结束 |

##### ``幻读(Phantom Reads)``：
1. 当用户读取某一个范围的数据行时，另一个事物又在该范围内查询了新行，当用户再读取该范围的数据行时，会发现会有新的“幻影行”，例如：事物$B$读到某一个数据$M$，事物$A$对数据$M$增加了一行并提交，事物$B$又读数据$M$，发生多出了一行造成的结果不一致(如果行数相同，则是不可重复读)。   
2. 原因：事物$B$根据相同的条件第二次查询到事物$A$提交的新增数据，两次数据结果集不一致。不符合事物的隔离性。
3. 例子：在事物$B$里，同一个数据集$M$，读到的条数不一致(新增，删除)。
    
| 事务$A$ | 事务$B$ |
| --- | --- |
|     | 读取数据集$M$(3行) |
| 在数据集$M$插入一行(4行)  |  |
| 事务结束 |  |
|  | 读取数据$M$(4行) |
|  | 事务结束 |


-------

#### 事务的隔离级别
数据库的事物隔离越严格，并发副作用越小，但付出的代价也就越大。因为事务隔离实质上是将事务在一定程度上“串行”进行，这显然与“并发”是矛盾的。实际业务中处理的话，根据自己的业务逻辑，权衡能接受的最大副作用，从而平衡了***“隔离” ***和***“并发” ***的问题。Mysql默认隔离级别是可重复读的。
事务的隔离级别通常有四种（RU, RC, RR，Serializable）：

| 隔离级别 | 读数据一致性 | 脏读可能性 | 不可重复读可能性 | 幻读可能性 | 加锁读 |
| --- | --- | --- | --- | --- | --- |
| 未提交读(Read uncommitted) | 最低级别 | Y | Y | Y  | N | 
| 已提交读(Read committed) | 语句级别 | N | Y | Y | N |
| 可重复读(Repeatable read) | 事务级别 | N | N | Y | N | 
| 可序列化(Serializable)  | 最高级别，事务级别 | N | N | N | Y |

-------

#### MySql常用命令

##### 查询隔离级别
select @@tx_isolation;

##### 设置手动提交
set autocommit=0 ;

##### 查看当前事务自动提交模式
select @@autocommit;

##### 设置隔离级别
set tx_isolation = 'READ-COMMITTED';

##### 查询表的状态
show table status like 'test1';

##### 修改表的存储引擎
alter table test1 engine = INNODB

##### 查看是否开启日志
show variables like 'log_bin';

##### 查看日志状态
show master status;

-------

#### 相关技术参考：
[深入浅出事务（1）](https://segmentfault.com/a/1190000004437223)
[深入浅出事务（2）](https://segmentfault.com/a/1190000004437275)
[深入浅出事务（3）](https://segmentfault.com/a/1190000004469395)
[MySQL表锁和行锁机制](https://segmentfault.com/a/1190000012773157)
[Mysql之锁与事务](https://juejin.im/post/5ab5e44a6fb9a028c97a013d)
[数据库 - 事务管理（ACID）、隔离级别、事务传播行为](https://segmentfault.com/a/1190000013122242)




